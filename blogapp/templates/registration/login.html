{% extends 'blogapp/base.html' %}
{% load widget_tweaks %}

{% block content %}
    <div class="max-w-md mx-auto mt-16 p-8 bg-white dark:bg-gray-800 rounded-2xl shadow-md transition-colors duration-500">
        <h2 class="text-3xl font-bold text-center text-gray-900 dark:text-white mb-6">Iniciar Sesión</h2>
        <form id="login-form" method="post" class="space-y-4">
            {% csrf_token %}
            
            {# Mensajes de Django (se mantienen por si la vista los pasa) #}
            {% if messages %}
                <div class="space-y-2">
                    {% for message in messages %}
                        <div class="p-4 bg-red-500 text-white rounded mb-4" role="alert">
                            {{ message }}
                        </div>
                    {% endfor %}
                </div>
            {% endif %}

            {# Mensajes de error/éxito de JavaScript #}
            <div id="js-messages" class="hidden p-4 rounded mb-4" role="alert"></div>

            {# Campos del formulario (simplificados para JS) #}
            <div>
                <label for="id_username" class="block mb-1 text-gray-700 dark:text-gray-300">Nombre de Usuario</label>
                <input type="text" name="username" id="id_username" required
                       class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div>
                <label for="id_password" class="block mb-1 text-gray-700 dark:text-gray-300">Contraseña</label>
                <input type="password" name="password" id="id_password" required
                       class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            
            <button type="submit" id="submit-button" class="w-full py-2 px-4 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition duration-300">
                Iniciar Sesión
            </button>
            <div id="loading-spinner" class="hidden loader ease-linear rounded-full border-4 border-t-4 border-blue-500 h-8 w-8 mx-auto"></div>
        </form>
        <div class="mt-6 text-center text-sm text-gray-600 dark:text-gray-400">
            ¿No tienes cuenta?
            <a href="{% url 'blogapp:signup' %}" class="text-blue-500 hover:underline">Regístrate aquí</a>
        </div>
    </div>
{% endblock %}

{% block extra_scripts %}
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const loginForm = document.getElementById('login-form');
            const submitButton = document.getElementById('submit-button');
            const loadingSpinner = document.getElementById('loading-spinner');
            const jsMessages = document.getElementById('js-messages');

            loginForm.addEventListener('submit', async (event) => {
                event.preventDefault(); // Evita el envío tradicional del formulario

                jsMessages.classList.add('hidden');
                jsMessages.textContent = '';
                submitButton.disabled = true;
                loadingSpinner.classList.remove('hidden');

                const username = document.getElementById('id_username').value;
                const password = document.getElementById('id_password').value;

                const mutation = `
                    mutation ObtainTokenMutation($username: String!, $password: String!) {
                        obtainToken(username: $username, password: $password) {
                            token
                            refreshToken 
                            user {
                                id
                                username
                                email
                            }
                        }
                    }
                `;

                try {
                    const response = await fetch('/graphql/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCsrfToken(), // getCsrfToken() viene de base.html
                            'Accept': 'application/json',
                        },
                        body: JSON.stringify({
                            query: mutation,
                            variables: { username, password }
                        })
                    });

                    const result = await response.json();

                    if (result.errors) {
                        console.error('Errores de GraphQL:', result.errors);
                        const errorMsg = result.errors.map(err => err.message).join('<br>');
                        displayMessage(`Error de inicio de sesión: <br>${errorMsg}`, 'bg-red-100 text-red-700');
                    } else if (result.data.obtainToken && result.data.obtainToken.token) {
                        const token = result.data.obtainToken.token;
                        const refreshToken = result.data.obtainToken.refreshToken; // Guardar el refresh token
                        
                        localStorage.setItem('authToken', token);
                        localStorage.setItem('refreshToken', refreshToken); // Almacenar también el refresh token
                        
                        displayMessage('Sesión iniciada con éxito.', 'bg-green-100 text-green-700');
                        // Redirigir a la página principal del blog después de un breve retraso
                        setTimeout(() => {
                            window.location.href = '{% url "blogapp:blog_list" %}'; // Redirige a tu lista de blogs
                        }, 1500);
                    } else {
                        displayMessage('Credenciales inválidas. Por favor, inténtalo de nuevo.', 'bg-red-100 text-red-700');
                    }

                } catch (networkError) {
                    console.error('Error de red:', networkError);
                    displayMessage('Error de conexión. Por favor, revisa tu red.', 'bg-red-100 text-red-700');
                } finally {
                    submitButton.disabled = false;
                    loadingSpinner.classList.add('hidden');
                }
            });

            // displayMessage() se define en base.html ahora, pero puedes definir una local si prefieres
            function displayMessage(message, classes) {
                jsMessages.innerHTML = message;
                jsMessages.className = classes + ' p-4 rounded mb-4';
                jsMessages.classList.remove('hidden');
            }
        });
    </script>
{% endblock %}
